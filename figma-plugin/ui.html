<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Image Size Converter</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #ffffff;
      color: #333;
      padding: 16px;
    }

    .container {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .preview-section {
      border: 1px solid #e5e5e5;
      border-radius: 8px;
      padding: 16px;
      text-align: center;
    }

    .preview-header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 12px;
    }

    .preview-title {
      font-size: 14px;
      font-weight: 600;
      color: #666;
    }

    .refresh-button {
      width: 20px;
      height: 20px;
      border: none;
      background: #f0f0f0;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      transition: background-color 0.2s;
    }

    .refresh-button:hover {
      background: #e0e0e0;
    }

    .preview-image {
      width: 200px;
      height: 200px;
      border: 1px solid #e5e5e5;
      border-radius: 4px;
      background: #f9f9f9;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto;
      overflow: hidden;
    }

    .preview-image img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .preview-placeholder {
      color: #999;
      font-size: 12px;
    }

    .button {
      padding: 12px 16px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      position: relative;
    }

    .button-primary {
      background: #18a0fb;
      color: white;
    }

    .button-primary:hover:not(:disabled) {
      background: #0d8ce8;
    }

    .button-secondary {
      background: #f0f0f0;
      color: #333;
    }

    .button-secondary:hover:not(:disabled) {
      background: #e0e0e0;
    }

    .button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .loading-spinner {
      width: 16px;
      height: 16px;
      border: 2px solid transparent;
      border-top: 2px solid currentColor;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .hidden {
      display: none !important;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .status-message {
      padding: 12px;
      border-radius: 6px;
      font-size: 14px;
      text-align: center;
      margin-top: 8px;
    }

    .status-success {
      background: #e8f5e8;
      color: #2d5a2d;
      border: 1px solid #c3e6c3;
    }

    .status-error {
      background: #ffeaea;
      color: #8b0000;
      border: 1px solid #ffcccc;
    }

    .status-info {
      background: #e8f4fd;
      color: #1e5a8a;
      border: 1px solid #b3d9ff;
    }

    .export-instructions {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 6px;
      padding: 12px;
      font-size: 13px;
      line-height: 1.4;
    }

    .export-instructions h4 {
      margin: 0 0 8px 0;
      font-size: 14px;
      font-weight: 600;
      color: #333;
    }

    .export-instructions ol {
      margin: 0;
      padding-left: 16px;
    }

    .export-instructions li {
      margin-bottom: 4px;
    }

    .export-instructions .highlight {
      background: #fff3cd;
      padding: 1px 4px;
      border-radius: 3px;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- 미리보기 섹션 -->
    <div class="preview-section">
      <div class="preview-header">
        <span class="preview-title">이미지 미리보기</span>
        <button class="refresh-button" id="refreshButton" title="새로고침">🔄</button>
      </div>
      <div class="preview-image" id="previewImage">
        <div class="preview-placeholder">미리보기를 불러오는 중...</div>
      </div>
    </div>

    <!-- 변환 버튼 -->
    <button class="button button-primary" id="convertButton">
      <span id="convertText">이미지 변환</span>
      <div class="loading-spinner hidden" id="convertSpinner"></div>
    </button>

    <!-- 내보내기 버튼 -->
    <button class="button button-secondary" id="exportButton">
      <span id="exportText">프레임 내보내기</span>
      <div class="loading-spinner hidden" id="exportSpinner"></div>
    </button>

    <!-- 초기화 버튼 -->
    <button class="button button-secondary" id="resetButton">
      <span id="resetText">초기화</span>
      <div class="loading-spinner hidden" id="resetSpinner"></div>
    </button>

    <!-- 내보내기 안내 -->
    <div id="exportInstructions" class="export-instructions hidden">
      <h4>📁 Figma Export 사용 방법</h4>
      <ol>
        <li><span class="highlight" id="frameCount">프레임들이 선택되었습니다</span></li>
        <li>Figma 우측 패널의 <span class="highlight">"Export"</span> 섹션을 확인하세요</li>
        <li><span class="highlight">"Export N layers"</span> 버튼을 클릭하세요</li>
        <li>폴더 구조가 자동으로 유지됩니다</li>
      </ol>
    </div>

    <!-- 상태 메시지 -->
    <div id="statusMessage" class="status-message hidden"></div>
  </div>

  <script>
    // DOM 요소들
    const previewImage = document.getElementById('previewImage');
    const refreshButton = document.getElementById('refreshButton');
    const convertButton = document.getElementById('convertButton');
    const convertText = document.getElementById('convertText');
    const convertSpinner = document.getElementById('convertSpinner');
    const exportButton = document.getElementById('exportButton');
    const exportText = document.getElementById('exportText');
    const exportSpinner = document.getElementById('exportSpinner');
    const resetButton = document.getElementById('resetButton');
    const resetText = document.getElementById('resetText');
    const resetSpinner = document.getElementById('resetSpinner');
    const exportInstructions = document.getElementById('exportInstructions');
    const statusMessage = document.getElementById('statusMessage');

    // 새로고침 버튼 클릭 이벤트
    refreshButton.addEventListener('click', () => {
      parent.postMessage({ pluginMessage: { type: 'get-preview' } }, '*');
    });

    // 변환 버튼 클릭 이벤트
    convertButton.addEventListener('click', () => {
      parent.postMessage({ pluginMessage: { type: 'convert-images' } }, '*');
    });

    // 내보내기 버튼 클릭 이벤트
    exportButton.addEventListener('click', () => {
      parent.postMessage({ pluginMessage: { type: 'export-frames' } }, '*');
    });

    // 초기화 버튼 클릭 이벤트
    resetButton.addEventListener('click', () => {
      parent.postMessage({ pluginMessage: { type: 'reset-images' } }, '*');
    });

    // 메시지 수신 처리
    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      if (!msg) return;

      console.log('UI 메시지 수신:', msg.type);

      switch (msg.type) {
        case 'preview-success':
          showPreview(msg.imageData);
          showStatusMessage('미리보기가 업데이트되었습니다.', 'success');
          break;

        case 'preview-error':
          showPreviewError(msg.message);
          showStatusMessage(msg.message, 'error');
          break;

        case 'conversion-started':
          startConvertLoading();
          showStatusMessage('이미지 변환을 시작합니다...', 'info');
          break;

        case 'conversion-completed':
          clearConvertLoading();
          showStatusMessage('이미지 변환이 완료되었습니다.', 'success');
          break;

        case 'export-started':
          startExportLoading();
          showStatusMessage('프레임을 선택하는 중...', 'info');
          break;

        case 'export-completed':
          clearExportLoading();
          showStatusMessage('내보내기가 완료되었습니다.', 'success');
          exportInstructions.classList.remove('hidden');
          const frameCountElement = document.getElementById('frameCount');
          if (frameCountElement) {
            frameCountElement.textContent = `${msg.frameCount}개의 프레임이 선택되었습니다`;
          }
          break;

        case 'reset-started':
          startResetLoading();
          showStatusMessage('이미지를 초기화하는 중...', 'info');
          break;

        case 'reset-completed':
          clearResetLoading();
          showStatusMessage(msg.message, 'success');
          break;

        case 'error':
          clearAllLoading();
          showStatusMessage(msg.message, 'error');
          break;
      }
    };

    // 미리보기 표시
    function showPreview(imageData) {
      previewImage.innerHTML = `<img src="data:image/png;base64,${imageData}" alt="미리보기">`;
    }

    // 미리보기 오류 표시
    function showPreviewError(message) {
      previewImage.innerHTML = `<div class="preview-placeholder">${message}</div>`;
    }

    // 상태 메시지 표시
    function showStatusMessage(message, type) {
      statusMessage.textContent = message;
      statusMessage.className = `status-message status-${type}`;
      statusMessage.classList.remove('hidden');
      
      // 3초 후 자동 숨김
      setTimeout(() => {
        statusMessage.classList.add('hidden');
      }, 3000);
    }

    // 로딩 상태 관리
    function startConvertLoading() {
      convertButton.disabled = true;
      convertText.textContent = '변환 중';
      convertSpinner.classList.remove('hidden');
    }

    function clearConvertLoading() {
      convertButton.disabled = false;
      convertText.textContent = '이미지 변환';
      convertSpinner.classList.add('hidden');
    }

    function startExportLoading() {
      exportButton.disabled = true;
      exportText.textContent = '선택 중';
      exportSpinner.classList.remove('hidden');
    }

    function clearExportLoading() {
      exportButton.disabled = false;
      exportText.textContent = '프레임 내보내기';
      exportSpinner.classList.add('hidden');
    }

    function startResetLoading() {
      resetButton.disabled = true;
      resetText.textContent = '초기화 중';
      resetSpinner.classList.remove('hidden');
    }

    function clearResetLoading() {
      resetButton.disabled = false;
      resetText.textContent = '초기화';
      resetSpinner.classList.add('hidden');
    }

    function clearAllLoading() {
      clearConvertLoading();
      clearExportLoading();
      clearResetLoading();
    }

    // 플러그인 시작 시 미리보기 로드
    parent.postMessage({ pluginMessage: { type: 'get-preview' } }, '*');
  </script>
</body>
</html>
